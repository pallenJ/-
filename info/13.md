# 13

[이전](./12.md)|[index 페이지로](./00index.md) |[다음](./14.md)
---|---|---
<hr>

### 목차

1. [url 인코딩 디코딩](#URL-Encode---Decode)
1. [CSRF](#CSRF) 
1. [XSS](#XSS)

### URL Encode - Decode
  
  - URL 인코딩(Encoding)

    + 문자나 특수문자를 웹 서버와 브라우저에서 보편적으로 허용되는 형식으로 변화하는 메커니즘이다.
    + URL은 ASCII 문자 집합을 사용하여 인터넷을 통해서만 전송할 수 있다.
    + URL은 종종 ASCII 세트 외부의 문자를 포함하기 때문에 URL은 유효한 ASCII 형식으로 변환되어야 한다.
    + URL 인코딩은 안전하지 않은 ASCII 문자를 "%" 다음에 두 개의 16진수로 대체한다.
    + URL은 공백을 포함할 수 없습니다. URL 인코딩은 일반적으로 공백을 더하기 (+) 기호 또는 % 20으로 바꾼다.
    + 고로, 아스키 이외의 문자는 다 인코딩 해야된다. (한글, 일본어, 중국어, 독일어, ... )
  
  - URL 디코딩(Decoding)
    
    + 인코딩과 쌍을 이룬다. url정보를 해석하기 위한 용도이다.

    
    + 각 언어 URL 인코딩 기능 

      * PHP : rawurlencode() 함수 
      * ASP : Server.URLEncode() 함수
      * Java Script : encodeURLComponent() 함수


- 인코딩/ 디코딩 테스트는 <http://www.convertstring.com/ko/EncodeDecode> 참조
      
  
### CSRF

- CSRF 공격(Cross Site Request Forgery)은 웹 어플리케이션 취약점 중 하나로 인터넷 사용자(희생자)가 자신의 의지와는 무관하게 공격자가 의도한 행위(수정, 삭제, 등록 등)를 특정 웹사이트에 요청하게 만드는 공격이다.

- CSRF를 통해 해커는 희생자의 권한을 도용하여 중요 기능을 실행하는 것이 가능하다. 와닿게 예시를 들어본다면 페이스북에 희생자의 계정으로 광고성 글을 올리는 것 같은걸 생각하면 된다.(설명을 위한 단순한 예시.)

- CSRF는 해커가 사용자PC를 감염시키거나 서버를 해킹해서 이루어 지는것이 아니며 다음 두가지 조건이 필요하다.

  + 위조 요청을 전송하는 서비스에 희생자가 로그인 상태
  + 희생자가 해커가 만든 피싱 사이트에 접속

- 페이스북, 구글 등 PC에서 자동로그인이 설정되어 있는 사용자가 많고 스팸팝업광고나 피싱메일, 19금사이트 등을 통해 접속될 수 있다.<br>
또한 해커가 만든 피싱 사이트를 하지 않더라도 해커가 XSS 공격을 성공한 정상 사이트를 통해 CSRF 공격이 수행될 수 도 있다.

- 이런 CSRF 공격을 막기위한 방법들은 다음과 같다.
  
  + Referrer 검증
    
    Back-end 단에서 request의 referrer를 확인하여 domain 이 일치하는 지 검증하는 방법.<br> 
    일반적으로 referrer 검증만으로 대부분의 CSRF 공격을 방어할 수 있다. 하지만 같은 도메인 내의 페이지에 XSS 취약점이 있는 경우 CSRF 공격에 취약해질 수 있다.<br> 
    domain 단위 검증에서 좀 더 세밀하게 페이지 단위까지 일치하는지 검증을 하면 도메인 내의 타 페이지에서의 XSS 취약점에 의한 CSRF 공격을 방어할 수 있다.

  + Security Token 사용 (A.K.A CSRF Token)
    
    Referrer 검증이 불가한 환경이라면, Security Token를 활용할 수 있다. <br>우선 사용자의 세션에 임의의 난수 값을 저장하고 사용자의 요청 마다 해당 난수 값을 포함 시켜 전송시킨다.<br> 이후 Back-end 단에서 요청을 받을 때마다 세션에 저장된 토큰 값과 요청 파라미터에 전달되는 토큰 값이 일치하는 지 검증하는 방법이다. 그러나 이 방법도 결국 같은 도메인 내에 XSS 취약점이 있다면 CSRF 공격에 취약해진다.
  
  + Double Submit Cookie 검증

    Double Submit Cookie 검증은 Security Token 검증의 한 종류로 세션을 사용할 수 없는 환경에서 사용할 수 있는 방법이다.<br>
    웹브라우저의 Same Origin 정책으로 인해 자바스크립트에서 타 도메인의 쿠키 값을 확인/수정하지 못한다는 것을 이용한 방어 기법이다.<br>
    스크립트 단에서 요청 시 난수 값을 생성하여 쿠키에 저장하고 동일한 난수 값을 요청 파라미터(혹은 헤더)에도 저장하여 서버로 전송하며 서버단에서는 쿠키의 토큰 값와 파라미터의 토큰 값이 일치하는 지만 검사하면 된다.<br> 
    서버에 따로 토큰 값을 저장할 필요가 없어 위에서 살펴본 세션을 이용한 검증보다 개발 공수가 적은 편이다. 피싱 사이트에서는 도메인이 달라 웹사이트에 쿠키에 값을 저장하지 못하므로 가능한 방어 기법이다.

### XSS

- XSS란?

  + Cross-site Scripting의 약자로 CSS와 구분하기 위해 XSS라 부름.
  + SQL injection과 함께 웹 상에서 가장 기초적인 취약점 공격 방법의 일종으로, 악의적인 사용자가 공격하려는 사이트에 스크립트를 넣는 기법을 말한다
    * 사실 XSS와 SQL Injection은 그 경계가 모호하다. XSS가 javascript를 이용해서 공격한다면 SQL Injection은 파라미터를 통해 잘못된 Query가 실행하게 하는 정도의 차이고 둘은 공격방식이나 방어방식이나 상당히 유사하다.
  + 공격 방법이 단순하고 가장 기초적이지만, 많은 웹사이트들이 XSS에 대한 방어 조치를 해두지 않아 공격을 받는 경우가 많다. 
  여러 사용자가 접근 가능한 게시판 등에 코드를 삽입하는 경우도 많으며, 경우에 따라서는 메일과 같은 매체를 통해서도 전파된다. 
  심지어는 닉네임에 코드를 심기도 한다
  + HTML을 사용하는 것이기 때문에, Text-Only 게시판이나, BBCode를 이용하는 위키위키 등에서는 XSS가 발생할 일은 없다.
  + 크게 **Reflected XSS, Stored XSS, DOM Based XSS** 이 3가지로분류할 수 있다.
  
 - 방어방법
 
    + 입력 필터
    
      * 적당한 XSS 필터를 만든 뒤, web.xml에 선언하여 모든 파라미터가 해당 필터를 거치도록 하는것 만으로도 좋은 효과를 볼 수 있다.

      * PHP는 입력을 처리할 때, 정규식을 이용하는 preg_replace를 사용하거나, 노드를 이용하는 DOMDocument를 사용할 수 있다. 속도는 preg_replace가 더 빠르지만, 정규식의 경우 예외와 오류가 종종 발생하기 때문에, 더 안전한 DOMDocument를 사용하는 것이 권장된다
        
      * 방식은 다음과 같다
   
        > 필터제작
   
        단순히 텍스트만 입력시키거나 출력하는 데 필터를 제작할 때, 주로 필터되는 것이 \<와 >이다. 각각 `&lt;`  와 `&gt;` 처럼 HTML 문자로 바꾸어서 HTML 코드가 아닌 단순 문자로 인식하게 하는 것이다. 하지만, 이 경우는 모든 HTML 태그를 막아버리기 때문에, 각종 스타일을 적용시켜야하는 사이트에서는 맞지 않을 수도 있다.
   
          
   + 출력 필터 
      *  HTML5부터 iframe의 sandbox 옵션으로 iframe 내의 자바스크립트, 폼과 같은 것의 제한이 가능해 졌으므로, 입력필터를 실행한 뒤 2차적으로 써보는 것도 좋다. 단, 어디까지나 2차로만 사용하는 것이 좋다. 구버전의 웹 브라우저라면 호환이 되지 않아 스크립트가 그대로 실행되거나, 설령 그게 아니더라도 웹 브라우저에서 취약점이 발견될 경우, 이런 방법이 뚫릴 수 있기 때문이다.
      
      ###### 라이브러리 제작

iframe은 단순히 다른 웹사이트를 불러오는 것만이 아니라, 부모 창에서 마음대로 수정할 수 있기 때문에, 무식하게 다른 페이지를 불러오며 AJAX나 PJAX 등을 포기하며 사용하지 말자. 물론, 기존부터 라이브러리를 사용하지 않고 웹 페이지를 개발하는 사람은 물론이고, jQuery같은 라이브러리를 사용하는 사람들도 조금만 검색해보면 간단하게 iframe의 내용을 수정할 수 있는 방법이 나오니 도전해 보도록 하자.
  
[이전](./12.md)|[index 페이지로](./00index.md) |[다음](./14.md)
---|---|---
